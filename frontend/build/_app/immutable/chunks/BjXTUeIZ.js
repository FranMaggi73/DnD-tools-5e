import{w as E}from"./CuU0tWjs.js";import{t as f,a as g,u as T}from"./8E2ohCEn.js";import{U as u}from"./CQqHTK8U.js";import{b as y}from"./SB3GKwJC.js";function C(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}const k=E("ðŸŽ² Grimorio de Aventuras");let m=null;async function w(){try{const e=y.currentUser;if(!e)return console.warn("No hay usuario autenticado para renovar token"),null;const t=await e.getIdToken(!0);return f.set(t),g.set(Date.now()),console.log("âœ… Token renovado exitosamente"),t}catch(e){return console.error("âŒ Error renovando token:",e),null}}function N(){m&&clearInterval(m);const e=50*60*1e3;m=setInterval(async()=>{u(T)&&(console.log("ðŸ”„ RenovaciÃ³n automÃ¡tica de token..."),await w())},e),console.log("âœ… Sistema de renovaciÃ³n de tokens iniciado")}function O(){m&&(clearInterval(m),m=null,console.log("â¹ï¸ Sistema de renovaciÃ³n de tokens detenido"))}async function h(){const e=u(g),t=50*60*1e3;return Date.now()-e>t?(console.log("âš ï¸ Token prÃ³ximo a expirar, renovando..."),await w()):u(f)}const l="https://dm-events-backend-858373640437.us-central1.run.app/api";async function n(e,t={}){const r=await h();if(!r)throw new Error("No se pudo obtener un token vÃ¡lido");const o={"Content-Type":"application/json",...t.headers};o.Authorization=`Bearer ${r}`;const a=await fetch(`${l}${e}`,{...t,headers:o});if(a.status===401){console.warn("âš ï¸ Token expirado, intentando renovar...");const s=await h();if(s){o.Authorization=`Bearer ${s}`;const i=await fetch(`${l}${e}`,{...t,headers:o});if(!i.ok){const c=await i.json().catch(()=>({error:"Error en la peticiÃ³n"}));throw new Error(c.error||"Error en la peticiÃ³n")}return i.json()}throw new Error("Token expirado y no se pudo renovar")}if(!a.ok){const s=await a.json().catch(()=>({error:"Error en la peticiÃ³n"}));throw new Error(s.error||"Error en la peticiÃ³n")}return a.json()}const P={createCampaign:e=>n("/campaigns",{method:"POST",body:JSON.stringify(e)}),getCampaigns:()=>n("/campaigns"),getCampaign:e=>n(`/campaigns/${e}`),deleteCampaign:e=>n(`/campaigns/${e}`,{method:"DELETE"}),getCampaignMembers:e=>n(`/campaigns/${e}/members`),invitePlayer:(e,t)=>n(`/campaigns/${e}/invite`,{method:"POST",body:JSON.stringify({userEmail:t})}),removePlayer:(e,t)=>n(`/campaigns/${e}/players/${t}`,{method:"DELETE"}),getMyInvitations:()=>n("/invitations"),respondToInvitation:(e,t)=>n(`/invitations/${e}/respond`,{method:"POST",body:JSON.stringify({action:t})}),createCharacter:(e,t)=>n(`/campaigns/${e}/characters`,{method:"POST",body:JSON.stringify(t)}),getCampaignCharacters:e=>n(`/campaigns/${e}/characters`),updateCharacter:(e,t)=>n(`/characters/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteCharacter:e=>n(`/characters/${e}`,{method:"DELETE"}),createEncounter:(e,t)=>n(`/campaigns/${e}/encounters`,{method:"POST",body:JSON.stringify({name:t})}),getActiveEncounter:e=>n(`/campaigns/${e}/encounters/active`),endEncounter:e=>n(`/encounters/${e}`,{method:"DELETE"}),resetEncounter:e=>n(`/encounters/${e}/reset`,{method:"POST"}),addCombatant:(e,t)=>n(`/encounters/${e}/combatants`,{method:"POST",body:JSON.stringify(t)}),getCombatants:e=>n(`/encounters/${e}/combatants`),updateCombatant:(e,t)=>n(`/combatants/${e}`,{method:"PUT",body:JSON.stringify(t)}),removeCombatant:e=>n(`/combatants/${e}`,{method:"DELETE"}),nextTurn:e=>n(`/encounters/${e}/next-turn`,{method:"POST"}),createNote:(e,t)=>n(`/campaigns/${e}/notes`,{method:"POST",body:JSON.stringify(t)}),getCampaignNotes:e=>n(`/campaigns/${e}/notes`),getNote:e=>n(`/notes/${e}`),updateNote:(e,t)=>n(`/notes/${e}`,{method:"PUT",body:JSON.stringify(t)}),deleteNote:e=>n(`/notes/${e}`,{method:"DELETE"})},I={searchMonsters:async e=>{const t=e.trim().toLowerCase(),r=await fetch(`https://api.open5e.com/v1/monsters/?search=${encodeURIComponent(t)}&limit=50`);if(!r.ok)throw new Error("Error buscando criaturas");const o=await r.json();return o.results&&(o.results=o.results.filter(a=>{var c;const s=a.name.toLowerCase(),i=((c=a.type)==null?void 0:c.toLowerCase())||"";return s.includes(t)||i.includes(t)}).sort((a,s)=>{const i=a.name.toLowerCase(),c=s.name.toLowerCase(),d=i.startsWith(t),p=c.startsWith(t);return d&&!p?-1:!d&&p?1:i.length-c.length}).slice(0,20)),o},getMonster:async e=>{const t=await fetch(`https://api.open5e.com/v1/monsters/${e}/`);if(!t.ok)throw new Error("Error obteniendo criatura");return t.json()},monsterToCombatant:(e,t)=>({type:"creature",name:e.name,initiative:t,maxHp:e.hit_points,currentHp:e.hit_points,armorClass:e.armor_class,isNpc:!0,creatureSource:"open5e"}),searchConditions:async e=>{const t=await fetch(`https://api.open5e.com/v1/conditions/?search=${encodeURIComponent(e)}&limit=5`);if(!t.ok)throw new Error("Error buscando condiciones");return t.json()},getCondition:async e=>{const t=await fetch(`https://api.open5e.com/v1/conditions/${e}/`);if(!t.ok)throw new Error("Error obteniendo condiciÃ³n");return t.json()},cleanDescription:(e,t=150)=>{const r=document.createElement("div");r.innerHTML=e;let o=r.textContent||r.innerText||"";return o.length>t&&(o=o.substring(0,t)+"..."),o}};export{P as a,O as b,C as e,k as h,I as o,w as r,N as s};
